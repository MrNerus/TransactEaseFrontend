<div class="data-table-container">
  <div class="table-toolbar">
    <div class="search-box">
      <span class="material-icons search-icon">search</span>
      <input type="text" placeholder="Search..." [(ngModel)]="searchTerm" (input)="onSearchChange()">
    </div>

    <div class="toolbar-actions">
      <select [(ngModel)]="searchField" (change)="onSearchFieldChange()" class="field-select">
        <option value="all">All Fields</option>
        @for (field of controls().searchableFields; track field) {
        <option [value]="field">{{ field | titlecase }}</option>
        }
      </select>

      <button class="filter-btn" (click)="toggleFilter()">
        <span class="material-icons">filter_list</span>
        Filter
        @if (activeFilterCount() > 0) {
        <span class="badge">{{ activeFilterCount() }}</span>
        }
      </button>

      @for (a of actions(); track a.type) {
      @if (a.placement === 'global' && (a.permission == Permission.allowInteraction || a.permission ==
      Permission.viewOnly)) {
      <button (click)="action.emit({ type: a.type, row: null })" [disabled]="a.permission == Permission.viewOnly"
        class="primary-btn">
        <span class="material-icons">{{ a.icon }}</span>
        {{ a.label }}
      </button>
      }
      }
    </div>
  </div>

  <app-advanced-filter [isOpen]="isFilterOpen()" [schema]="controls()" (applyFilter)="onFilterApply($event)"
    (close)="toggleFilter()"></app-advanced-filter>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          @for (col of controls().columns; track col.key) {
          <th [class.sortable]="true">{{ col.label }}</th>
          }
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (row of data(); track row.id) {
        <tr tabindex="0" (dblclick)="action.emit({ type: 'rowClick', row: row })"
          (keydown.enter)="action.emit({ type: 'rowEnter', row: row })" class="data-row">
          @for (col of controls().columns; track col.key) {
          <td>
            @if (col.isDate) {
            {{ row[col.key] | date:'short' }}
            } @else if (col.isBoolean) {
            {{ row[col.key] ? 'Yes' : 'No' }}
            } @else if (col.key === 'role') {
            {{ row[col.key]?.name || 'N/A' }}
            } @else {
            {{ row[col.key] || 'N/A' }}
            }
          </td>
          }
          <td>
            @for (a of actions(); track a.type) {
            @if (a.placement === 'row' && (a.permission == Permission.allowInteraction || a.permission ==
            Permission.viewOnly)) {
            <button (click)="action.emit({ type: a.type, row })" title="{{ a.label }}"
              [disabled]="a.permission == Permission.viewOnly" class="action-btn">
              <span class="material-icons">{{ a.icon }}</span>
            </button>
            }
            }
          </td>
        </tr>
        }
        @empty {
        <tr>
          <td [attr.colspan]="controls().columns.length + 1">
            <div class="empty-state">
              <span class="material-icons">inbox</span>
              <p>No data found.</p>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <div class="pagination-controls">
    <div class="pagination-info">
      Showing {{ (currentPage() - 1) * pageSize() + 1 }} - {{ currentPage() * pageSize() > totalItems() ? totalItems() :
      currentPage() * pageSize() }} of {{ totalItems() }}
    </div>

    <div class="pagination-actions">
      <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
        @for (option of pageSizeOptions(); track option) {
        <option [value]="option">{{ option }} rows</option>
        }
      </select>

      <button (click)="firstPage()" [disabled]="currentPage() === 1" title="First Page" class="page-btn">
        <span class="material-icons">first_page</span>
      </button>
      <button (click)="previousPage()" [disabled]="currentPage() === 1" title="Previous Page" class="page-btn">
        <span class="material-icons">chevron_left</span>
      </button>

      <span class="page-numbers">
        <button class="page-number active">{{ currentPage() }}</button>
      </span>

      <button (click)="nextPage()" [disabled]="currentPage() === totalPages()" title="Next Page" class="page-btn">
        <span class="material-icons">chevron_right</span>
      </button>
      <button (click)="lastPage()" [disabled]="currentPage() === totalPages()" title="Last Page" class="page-btn">
        <span class="material-icons">last_page</span>
      </button>
    </div>
  </div>
</div>